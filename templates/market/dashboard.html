{% extends 'base.html' %}
{% load static %}

{% block content %}
    <header class="py-5 bg-dark border-bottom mb-4">
        <div class="container">
            <div class="text-center my-5">

                <h4 style="color: white;">Whaddaya Buyin?</h4>

                {% if user.is_authenticated %}

                <p style="color: gainsboro;">Whaddaya Sellin? <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#formModal">Add it!</button>

                {% else %}

                <p style="color: gainsboro;">You are not logged in. You must log in to add products.</p>
                <a href="{% url 'users:login-page' %}" style="color: aliceblue;">Log In</a>

                {% endif %}

                <br>
                <br>

                <center>    
                <div class="input-group mb-3" style="width: 50%;">
                    <input class="form-control" type="text" placeholder="Search" id="searchID">
                    <button class="btn btn-primary" type="button" id="searchBtn">Search</button>
                </div>
                </center>

            </div>
        </div>
    </header>

    <br>

<!-- Product Container -->
    <div class="container">
        <div class="row justify-content-center" id="prodContainer">
    
        </div>
    </div>

<!-- Form Modal -->    
    <div class="modal" id="formModal">
        <div class="modal-dialog" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">Add Product</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close">
                <span aria-hidden="true"></span>
              </button>
            </div>
            <form id="addProduct" action="" novalidate class="was-validated">
            {% csrf_token %}
            <div class="modal-body">

                    <div class="form-group">
                        <label for="exampleInputEmail1" class="form-label mt-4">Product Name</label>
                        <input type="text" class="form-control" name="prodName" aria-describedby="emailHelp" placeholder="Enter name" required>
                        <small id="nameError" class="errMsg"></small>
                    </div>
                    <div class="form-group">
                        <label for="exampleInputPassword1" class="form-label mt-4">Status</label>
                        <select class="form-select" name="status" id="status">
                            <option value=1>Available</option>
                            <option value=2>Out of stock</option>
                          </select>
                        <small id="fnameError" class="errMsg"></small>
                    </div>
                    <div class="form-group">
                        <label for="exampleInputPassword1" class="form-label mt-4">Category</label>
                        <select class="form-select" name="category" id="category">
                            <option value=1>Normies</option>
                            <option value=2>Dark</option>
                            <option value=3>Others</option>
                          </select>
                        <small id="lnameError" class="errMsg"></small>
                    </div>
                    <div class="form-group">
                        <label for="formFile" class="form-label mt-4">Product Image</label>
                        <input class="form-control" type="file" id="prodImg" name="prodImg" accept="image/*">
                        <small id="imgError" class="errMsg"></small>
                    </div>

            </div>
            <div class="modal-footer">
              <button type="submit" class="btn btn-primary" id="frmBtn">Add</button>
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>

            </form>
          </div>
        </div>
      </div>
   
{% endblock %}

<!--Scripts-->

{% block extra_js %}
<script type="text/javascript" src="{% static 'js/market.js' %}" ></script>
<script>

 // JavaScript function to get cookie by name
 function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            // Does this cookie string begin with the name we want?
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
const csrftoken = getCookie('csrftoken');

//search dashboard
$(document).on("click", "#searchBtn", function(){
    var search = $("#searchID").val().split(' ').join('').toLowerCase()
    console.log(search.split(' ').join('').toLowerCase())
    
    $.ajax({
        type:"GET",
        url:"/list/",
        success: function(data){

            let temp = ""

            $("#prodContainer").empty();
            $.each(data, function(i,product){
                var prodOwner = product.owner.split('/')[0]
                var ownerID = product.owner.split('/')[1]
                if(product.product_name.split(' ').join('').toLowerCase() === search || prodOwner.split(' ').join('').toLowerCase() === search || product.category_name.split(' ').join('').toLowerCase() === search){
                    temp += "<div class='col-4'>"
                    temp += "<div class='card border-primary mb-3' style='max-width: 20rem;'>"
                    temp += "<div class='card-header'>" + prodOwner + "</div>"
                    temp += "<div class='card-body'>"
                    temp += "<h4 class='card-title'>" + product.product_name +"</h4>"
                    if(product.prod_pic){
                        temp += "<img src='" + product.prod_pic + "' class='img-fluid' id='prodPic'></img>"
                    }
                    else{
                        temp += "<img src='{% get_media_prefix %}defaultProdPic.png' id='prodPic'></img>"
                    }
                    temp += "<a href='users/profile-page/" + ownerID + "/' class='card-link'>Product seller details</a>"

                    if(product.status === 1){
                        temp += "<p style='color:green;'><strong style='color:grey;'>Status: </strong>" + product.status_name + "</p>"
                    }
                    else if(product.status === 2){
                        temp += "<p style='color:red;'><strong style='color:grey;'>Status: </strong>" + product.status_name + "</p>"
                    }
                    temp += "<p><strong>Category: </strong>" + product.category_name + "</p>"

                    temp += "</div><div class='card-footer'>"
                    temp += "<a href='/product-view/" + product.id + "/' class='btn btn-outline-dark' data-mdb-ripple-color='dark' style='z-index: 1;'>Details</a></div></div></div>"
                    
                    
                }

            })
            $("#prodContainer").append(temp);

        }
    })
      
})


//Post a product

$("form#addProduct").submit(function(event){
    event.preventDefault()

    var formData = new FormData()
    var name = $('input[name="prodName"]').val()
    var status = $('#status').val()
    var category = $('#category').val()

    if($('#prodImg').prop('files')[0] != undefined){
        formData.append('prod_pic', $('#prodImg')[0].files[0])
    }
    formData.append('product_name', name)
    formData.append('status', status)
    formData.append('category', category)

    let temp =""

    $.ajax({
        type: "POST",
        url: "/product/",
        data: formData,
        processData: false,
        contentType: false,
        beforeSend: function(xhr){
            xhr.setRequestHeader("X-CSRFToken", csrftoken);
        },
        success:function(){
            alert("Product Added")
            location.reload(true);

            // temp += "<div class='col-4'>"
            // temp += "<div class='card border-primary mb-3' style='max-width: 20rem;'>"
            // temp += "<div class='card-header'>{{ request.user.first_name }} {{ request.user.last_name }}</div>"
            // temp += "<div class='card-body'>"
            // temp += "<h4 class='card-title'>" + name +"</h4>"

            // if($('#prodImg').prop('files')[0] != undefined){
            //     temp += "<img src='" + URL.createObjectURL($('#prodImg').prop('files')[0]) + "' class='img-fluid' id='prodPic'></img>"
            // }
            
            // else{
            //     temp += "<img src='{% get_media_prefix %}defaultProdPic.png' id='prodPic'></img>"
            // }

            // temp += "<a href='#' class='card-link'>Product seller details</a>"
            // if($("#status").val() == 1){
            //     temp += "<p style='color:green;'><strong style='color:grey;'>Status: </strong>" + $("#status option:selected").text() + "</p>"
            // }
            // else if($("#status").val() == 2){
            //     temp += "<p style='color:red;'><strong style='color:grey;'>Status: </strong>" + $("#status option:selected").text() + "</p>"
            // }
            // temp += "<p><strong>Status: </strong>" + $("#category option:selected").text() + "</p>"
            // temp += "</div><div class='card-footer'>"
            // temp += "<a href='/product-view/" + product.id + "/' class='btn btn-outline-dark' data-mdb-ripple-color='dark' style='z-index: 1;'>Details</a></div></div></div>"
            // $("#prodContainer").append(temp);
        },
        error:function(error){
            console.log(error)
            $('#nameError').show()
            $("#nameError").html("Product name required")
        }
    })
})

</script>
{% endblock %}