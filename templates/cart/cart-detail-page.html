{% extends 'base.html' %}
{% load static %}

{% block content %}

<!-- Product Container -->
<div class="container">
</div>

<!-- Checkout modal -->
<div class="modal" id="checkOutModal">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Checkout</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close">
            <span aria-hidden="true"></span>
          </button>
        </div>
        <div class="modal-body">
          <center><h5>Please confirm checkout</h5></center>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-primary"  id='checkOut'>Confirm</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        </div>
      </div>
    </div>
  </div>

{% endblock %}
{% block extra_js %}

<script>
    // JavaScript function to get cookie by name
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                // Does this cookie string begin with the name we want?
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    var pathname = window.location.pathname;
    const cartID = pathname.split('/')[3]
    var prodID
    var qty
    var avail_stock

    //get product in cart
    $(document).ready(function(){
        
        let temp = ""

        $.ajax({
            type: 'GET',
            url : "cart/cart-detail-api/" + cartID + "/",
            success : function(data){
                console.log(data)

                let temp = ""

                $.ajax({
                    type: "GET",
                    url: "product-detail/" + data.product + "/",
                    success:function(prod){
                        if(prod){
                            var prodOwner = prod.data.owner.split('/')[0]
                            var ownerID = prod.data.owner.split('/')[1]
                            var total_price = prod.data.price * parseFloat(data.quantity).toFixed(2)
                            prodID = prod.data.id
                            qty = data.quantity
                            avail_stock = prod.data.stock
                            console.log("{{user.id}}")
                            console.log(data.added_by.toString())
                            temp += "<div class='card mb-3'>"
                            temp += "<h5 class='card-header'> Seller:<a href='users/profile-page/" + ownerID + "/'>" + prodOwner + "</h5></a>"
                            temp += "<div class='card-body'>"
                            temp += "<h3 class='card-title'>" + prod.data.product_name + "</h3></div>"

                            if(prod.data.prod_pic){
                                temp += "<center><img src='" + prod.data.prod_pic + "' id='prodPicDetail'></img></center>"
                            }
                            else{
                                temp += "<center><img src='{% get_media_prefix %}defaultProdPic.png' id='prodPicDetail'></img></center>"
                            }

                            temp += "<div class='card-body'>"
                            temp += "<p><strong style='color:grey;'>Date Added: </strong>" + data.date_added.split('T')[0] + "</p>"
                            temp += "<p><strong style='color:grey;'>Qty: </strong>" + data.quantity + "</p>"
                            temp += "<p><strong>Category: </strong>" + prod.data.category_name + "</p>"
                            temp += "<p><strong style='color:grey;'>Total Price: </strong>" + total_price + "php</p>"
                            temp += "<div class='card-footer text-muted'>"

                            if("{{user.id}}" === data.added_by.toString()){
                                temp += "<button class='btn btn-outline-primary' data-bs-toggle='modal' data-bs-target='#checkOutModal' style='margin-right: 5px;'>Check out</button>"
                                temp += "<button class='btn btn-outline-danger' id='delete' style='margin-right: 5px;'>Remove</button>"
                            }
                            temp += "</div></div>"
                            $(".container").append(temp);
                        }

                        //Check Out product
                        $(document).on("click", "#checkOut", function(){
                            console.log(prod.prod_pic)

                            $.ajax({
                                type: "POST",
                                url: "transaction/transact/",
                                data:{
                                    'product_name': prod.data.product_name,
                                    'seller': parseInt(ownerID),
                                    'buyer': parseInt("{{user.id}}"),
                                    'prod_pic': prod.data.prod_pic,
                                    'quantity': data.quantity
                                },
                                beforeSend: function(xhr){
                                xhr.setRequestHeader("X-CSRFToken", csrftoken);
                                },
                                success:function(){
                                    alert("Product Purchased");

                                    //Remove product from cart after purchase
                                    $.ajax({
                                        type: "POST",
                                        url: "cart/cart-detail-api/" + cartID + "/",
                                        beforeSend: function(xhr){
                                        xhr.setRequestHeader("X-CSRFToken", csrftoken);
                                        },
                                        success:function(){
                                            console.log("deleted from cart")
                                            window.location.href = "transaction/buyer/"
                                        }
                                    })

                                    

                                }
                            })

                        });

                    }
                })
            } 
        })
    })

    //Delete product
    $(document).on("click", "#delete", function(){
        $.ajax({
            type: "POST",
            url: "cart/cart-detail-api/" + cartID + "/",
            beforeSend: function(xhr){
            xhr.setRequestHeader("X-CSRFToken", csrftoken);
            },
            success:function(){
                alert("Removed");

                //update stock
                $.ajax({
                    type: "PATCH",
                    url: "product-detail/" + prodID + "/",
                    data:{
                        'stock': parseInt(avail_stock) + parseInt(qty)
                    },
                    beforeSend: function(xhr){
                        xhr.setRequestHeader("X-CSRFToken", csrftoken);
                    },
                    success:function(){
                        console.log("Stock updated")
                        window.location.href = "cart/cart-page/"
                    },
                    error:function(error){
                        console.log(error)
                        $('#nameError').show()
                        $("#nameError").html("Product name required")
                    }
                })

                window.location.href = "cart/cart-page/"
            }
        })
    }); 
    
</script>

{% endblock %}